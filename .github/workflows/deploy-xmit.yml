name: Deploy Eleventy to XMIT

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:
    inputs:
      site:
        description: "XMIT site/domain (e.g. jcrt.xmit.dev)"
        required: true
        type: string

concurrency:
  group: deploy-xmit-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  ELEVENTY_RUN_MODE: build
  NODE_OPTIONS: "--max-old-space-size=8192"
  # Use cached theory data â€” skip GitHub ZIP download in CI
  USE_CACHED_THEORY: "1"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      XMIT_SITE: jcrt.xmit.dev@268
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      # Cache the Eleventy build output (.cache for eleventy-img, etc.)
      - name: Cache Eleventy
        uses: actions/cache@v4
        with:
          path: |
            .cache
          key: eleventy-cache-${{ runner.os }}-${{ hashFiles('content/archives/**/*.pdf') }}
          restore-keys: |
            eleventy-cache-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Pre-copy archive assets (hardlinks)
        run: bash scripts/pre-copy-assets.sh

      - name: Build site
        run: |
          start_time=$(date +%s%3N)
          npx @11ty/eleventy --quiet
          end_time=$(date +%s%3N)
          echo "âš¡ Build completed in $((end_time - start_time))ms"
          echo "ðŸ“¦ Output: $(find _site -type f | wc -l) files, $(du -sh _site | cut -f1)"

      - name: Deploy to XMIT
        env:
          XMIT_KEY: ${{ secrets.XMIT_KEY }}
        run: |
          [ -z "$XMIT_KEY" ] && { echo "XMIT_KEY secret not set" >&2; exit 1; }
          SITE="${{ github.event_name == 'workflow_dispatch' && inputs.site || env.XMIT_SITE }}"
          echo "Deploying to $SITE"
          npx -y @xmit.co/xmit "$SITE" _site

      - name: Summary
        run: echo "âœ… Deployed to https://${{ env.XMIT_SITE }}"
